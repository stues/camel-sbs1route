<?xml version="1.0" encoding="UTF-8"?>
<!-- Configures the Camel Context -->

<beans xmlns="http://www.springframework.org/schema/beans"
	xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xmlns:camel="http://camel.apache.org/schema/spring"
	xmlns:context="http://www.springframework.org/schema/context"
	xmlns:util="http://www.springframework.org/schema/util"
	xsi:schemaLocation="
       http://www.springframework.org/schema/beans http://www.springframework.org/schema/beans/spring-beans.xsd
       http://www.springframework.org/schema/context http://www.springframework.org/schema/context/spring-context.xsd
       http://camel.apache.org/schema/spring http://camel.apache.org/schema/spring/camel-spring.xsd
       http://www.springframework.org/schema/util  http://www.springframework.org/schema/util/spring-util.xsd">

	<context:annotation-config />

	<bean
		class="org.springframework.beans.factory.config.PropertyPlaceholderConfigurer">
		<property name="locations" value="classpath*:sbs1route-config.properties" />
		<property name="properties">
			<props>
				<prop key="sbs1.enabled">true</prop>
				<prop key="sbs1.host"><!-- The SBS1 Station IP --></prop>
				<prop key="sbs1.port">30003</prop>

				<prop key="filter.minproperties">3</prop>
				<prop key="filter.duplicates.cleanupInterval">30000</prop>

				<prop key="generator.enabled">false</prop>
				<prop key="generator.amountOfTracks">20</prop>
				<prop key="generator.updateInterval">200</prop>
				<prop key="generator.initialDelay">10000</prop>
				<prop key="generator.duration">0</prop>
				<prop key="generator.trackAmountPerInterval">1</prop>

				<prop key="generator.useVariableInterval">false</prop>
				<prop key="generator.variableInterval.startAmount">1</prop>
				<prop key="generator.variableInterval.stepAmount">10</prop>
				<prop key="generator.variableInterval.stepSize">1</prop>
				<prop key="generator.variableInterval.stepDuration">30000</prop>
				<prop key="generator.variableInterval.delayBetweenSteps">2000</prop>
			</props>
		</property>
		<property name="systemPropertiesModeName" value="SYSTEM_PROPERTIES_MODE_OVERRIDE" />
	</bean>

	<import resource="sbs1-source-context.xml" />

	<bean id="randomTrackGenerator" class="ch.trackdata.sbs1route.generator.RandomTrackGenerator">
		<property name="producerTemplate" ref="generatedTrackProducer" />
		<property name="enabled" value="${generator.enabled}" />
		<property name="amountOfTracks" value="${generator.amountOfTracks}" />
		<property name="useVariableInterval" value="${generator.useVariableInterval}" />
		<property name="fixGeneratorInterval" ref="fixGeneratorInterval" />
		<property name="variableGeneratorInterval" ref="variableGeneratorInterval" />
		<property name="minLatitude" value="44" />
		<property name="maxLatitude" value="49" />
		<property name="minLongitude" value="4.5" />
		<property name="maxLongitude" value="14" />
		<property name="maxAltitudeDelta" value="40" />
		<property name="maxSpeedDelta" value="40" />
		<property name="maxHeadingDelta" value="40" />
	</bean>

	<bean id="fixGeneratorInterval" class="ch.trackdata.sbs1route.generator.FixGeneratorInterval">
		<property name="updateInterval" value="${generator.updateInterval}" />
		<property name="initialDelay" value="${generator.initialDelay}" />
		<property name="duration" value="${generator.duration}" />
		<property name="trackAmount" value="${generator.trackAmountPerInterval}" />
	</bean>

	<bean id="variableGeneratorInterval"
		class="ch.trackdata.sbs1route.generator.VariableGeneratorInterval">
		<property name="enabled" value="${generator.useVariableInterval}" />
		<property name="initialDelay" value="${generator.initialDelay}" />
		<property name="startTrackAmount" value="${generator.variableInterval.startAmount}" />
		<property name="amountOfSteps" value="${generator.variableInterval.stepAmount}" />
		<property name="stepSize" value="${generator.variableInterval.stepSize}" />
		<property name="stepDuration" value="${generator.variableInterval.stepDuration}" />
		<property name="delayBetweenSteps"
			value="${generator.variableInterval.delayBetweenSteps}" />
		<property name="trackAmount" value="${generator.trackAmountPerInterval}" />
	</bean>

	<camel:camelContext id="sbs1RouteCamelContext"
		xmlns="http://camel.apache.org/schema/spring">

		<propertyPlaceholder id="properties" location="sbs1route-config.properties" />

		<camel:template id="sbs1Producer" defaultEndpoint="direct:sbs1_in" />

		<camel:template id="generatedTrackProducer" defaultEndpoint="direct:trackgeneration" />

		<camel:route>
			<camel:from uri="direct:trackgeneration" />
			<camel:log message="${body}" logName="GEN_RECEIVED_FEATURE" />
			<camel:multicast stopOnException="false">
				<camel:when>
					<simple>${properties:websocket.enabled}</simple>
					<camel:to ref="websocketClientJSONEndpoint" />
				</camel:when>
				<camel:otherwise>
					<camel:stop />
				</camel:otherwise>

				<camel:to uri="direct:sos" />
			</camel:multicast>
		</camel:route>

		<camel:route autoStartup="true">
			<camel:from uri="direct:sbs1_in" />
			<camel:unmarshal ref="bindyDataformat" />
			<camel:process ref="sbs1Processor" />
			<convertBodyTo type="ch.trackdata.sbs1route.message.GeoJSONFeature" />
			<camel:process ref="filterDuplicateValueProcessor"></camel:process>
			<camel:when>
				<simple>${body.geometry} != null 
					|| ${body.properties.size} >= ${properties:filter.minproperties}</simple>
				<camel:log message="${body}" logName="RECEIVED_FEATURE" />
				<camel:to uri="direct:sbs1_out" />
			</camel:when>
			<camel:otherwise>
				<camel:stop />
			</camel:otherwise>
		</camel:route>

	</camel:camelContext>

</beans>